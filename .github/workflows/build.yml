name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    name: Code Validation
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: ['7.4', '8.0', '8.1', '8.2']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, mysql, pgsql
        coverage: xdebug
    
    - name: Validate PHP syntax
      run: |
        find . -name "*.php" -exec php -l {} \;
    
    - name: Check Moodle coding standards
      run: |
        # Verificar estructura b√°sica de archivos Moodle
        if [[ ! -f "version.php" ]]; then
          echo "‚ùå version.php es requerido"
          exit 1
        fi
        
        # Validaci√≥n espec√≠fica para m√≥dulos de actividad
        if [[ ! -f "lib.php" ]]; then
          echo "‚ùå lib.php es requerido para m√≥dulos de actividad"
          exit 1
        fi

        if [[ ! -f "mod_form.php" ]]; then
          echo "‚ùå mod_form.php es requerido para m√≥dulos de actividad"
          exit 1
        fi
        
        if [[ ! -d "db" ]]; then
          echo "‚ùå directorio db/ es requerido"
          exit 1
        fi
        
        if [[ ! -f "db/access.php" ]]; then
          echo "‚ùå db/access.php es requerido"
          exit 1
        fi
        
        echo "‚úÖ Estructura de archivos v√°lida"
    
    - name: Validate version.php format
      run: |
        php -r "
        require_once 'version.php';
        if (!isset(\$plugin)) {
          echo '‚ùå \$plugin no est√° definido en version.php' . PHP_EOL;
          exit(1);
        }
        if (!isset(\$plugin->component)) {
          echo '‚ùå component no est√° definido' . PHP_EOL;
          exit(1);
        }
        if (!isset(\$plugin->version)) {
          echo '‚ùå version no est√° definido' . PHP_EOL;
          exit(1);
        }
        echo '‚úÖ version.php v√°lido' . PHP_EOL;
        "

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run security checks
      run: |
        # Buscar patrones de seguridad problem√°ticos
        echo "üîç Buscando patrones de seguridad..."
        
        # Verificar que no hay eval() statements
        if grep -r "eval(" --include="*.php" .; then
          echo "‚ùå Encontrado uso de eval() - riesgo de seguridad"
          exit 1
        fi
